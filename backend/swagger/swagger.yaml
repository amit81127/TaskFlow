openapi: 3.0.3
info:
  title: Task Manager API
  description: |
    A production-ready REST API for task management with:
    - **JWT Authentication** (Access + Refresh tokens with rotation)
    - **Role-Based Access Control** (user, manager, admin)
    - **Full Task CRUD** with filtering, search & pagination
    - **Input Validation** on all endpoints
  version: 1.0.0
  contact:
    name: Task Manager Support
    email: support@taskmanager.com

servers:
  - url: http://localhost:5000/api/v1
    description: Local Development
  - url: https://your-production-url.com/api/v1
    description: Production

tags:
  - name: Auth
    description: Authentication & user profile
  - name: Tasks
    description: Task management (CRUD)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          example: "64f1a2b3c4d5e6f7a8b9c0d1"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        role:
          type: string
          enum: [user, manager, admin]
          example: "user"
        createdAt:
          type: string
          format: date-time

    Task:
      type: object
      properties:
        id:
          type: string
          example: "64f1a2b3c4d5e6f7a8b9c0d2"
        title:
          type: string
          example: "Build REST API"
        description:
          type: string
          example: "Create a production-ready API"
        status:
          type: string
          enum: [todo, in-progress, review, done]
          example: "todo"
        priority:
          type: string
          enum: [low, medium, high, critical]
          example: "high"
        dueDate:
          type: string
          format: date-time
          nullable: true
        tags:
          type: array
          items:
            type: string
          example: ["backend", "api"]
        owner:
          $ref: '#/components/schemas/User'
        assignedTo:
          $ref: '#/components/schemas/User'
          nullable: true
        isOverdue:
          type: boolean
        completedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
        data:
          type: object

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

    PaginatedResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: array
        pagination:
          type: object
          properties:
            total:
              type: integer
            page:
              type: integer
            limit:
              type: integer
            totalPages:
              type: integer
            hasNextPage:
              type: boolean
            hasPrevPage:
              type: boolean

# ─── Paths ────────────────────────────────────────────────────────────────────

paths:

  # ── Auth ──────────────────────────────────────────────────────────────────

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 50
                  example: "John Doe"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  minLength: 6
                  example: "secret123"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: '#/components/schemas/User'
                          accessToken:
                            type: string
                          refreshToken:
                            type: string
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and get tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  example: "secret123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: '#/components/schemas/User'
                          accessToken:
                            type: string
                          refreshToken:
                            type: string
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh-token:
    post:
      tags: [Auth]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: New access and refresh tokens
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AuthTokens'
        '401':
          description: Invalid or expired refresh token

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout (revoke refresh token)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logged out successfully
        '401':
          description: Unauthorized

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized

    patch:
      tags: [Auth]
      summary: Update current user profile
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Profile updated
        '401':
          description: Unauthorized

  # ── Tasks ─────────────────────────────────────────────────────────────────

  /tasks:
    post:
      tags: [Tasks]
      summary: Create a new task
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title:
                  type: string
                  minLength: 3
                  maxLength: 100
                  example: "Implement login page"
                description:
                  type: string
                  example: "Create a login form with validation"
                status:
                  type: string
                  enum: [todo, in-progress, review, done]
                priority:
                  type: string
                  enum: [low, medium, high, critical]
                dueDate:
                  type: string
                  format: date-time
                tags:
                  type: array
                  items:
                    type: string
                assignedTo:
                  type: string
                  description: User ObjectId
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          task:
                            $ref: '#/components/schemas/Task'
        '401':
          description: Unauthorized
        '422':
          description: Validation error

    get:
      tags: [Tasks]
      summary: Get my tasks (filtered, paginated)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [todo, in-progress, review, done]
        - in: query
          name: priority
          schema:
            type: string
            enum: [low, medium, high, critical]
        - in: query
          name: search
          schema:
            type: string
          description: Search in title and description
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
        - in: query
          name: sortBy
          schema:
            type: string
            default: createdAt
        - in: query
          name: order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Paginated task list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedResponse'
        '401':
          description: Unauthorized

  /tasks/stats:
    get:
      tags: [Tasks]
      summary: Get task statistics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Task counts by status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          stats:
                            type: object
                            properties:
                              todo:
                                type: integer
                              in-progress:
                                type: integer
                              review:
                                type: integer
                              done:
                                type: integer
                              total:
                                type: integer

  /tasks/admin/all:
    get:
      tags: [Tasks]
      summary: Get ALL tasks — Admin only
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: owner
          schema:
            type: string
          description: Filter by owner user ID
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        '200':
          description: All tasks (admin view)
        '403':
          description: Forbidden — Admin role required

  /tasks/{id}:
    get:
      tags: [Tasks]
      summary: Get task by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          task:
                            $ref: '#/components/schemas/Task'
        '403':
          description: Access denied
        '404':
          description: Task not found

    patch:
      tags: [Tasks]
      summary: Update a task
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                status:
                  type: string
                  enum: [todo, in-progress, review, done]
                priority:
                  type: string
                  enum: [low, medium, high, critical]
                dueDate:
                  type: string
                  format: date-time
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Task updated
        '403':
          description: Access denied
        '404':
          description: Task not found

    delete:
      tags: [Tasks]
      summary: Delete a task
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task deleted successfully
        '403':
          description: Access denied
        '404':
          description: Task not found
